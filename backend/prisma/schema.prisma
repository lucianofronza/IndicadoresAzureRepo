// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

/// @seed="npx tsx prisma/seed.ts"

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



// Entidades principais
model Team {
  id          String   @id @default(cuid())
  name        String   @unique
  management  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  developers Developer[]
  repositories Repository[]
  userTeams  UserTeam[]

  @@map("teams")
}

model Role {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  developers Developer[]

  @@map("roles")
}

model Stack {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String   @default("#3b82f6")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  developers Developer[]

  @@map("stacks")
}

model Developer {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  login     String   @unique
  azureId   String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  
  roleId    String?
  role      Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)
  
  stacks    Stack[]
  
  // Dados do Azure DevOps
  pullRequests PullRequest[]
  reviews      Review[]
  comments     Comment[]
  commits      Commit[]

  @@map("developers")
}

model Repository {
  id          String   @id @default(cuid())
  name        String
  url         String   @unique
  organization String
  project     String
  azureId     String?  @unique
  personalAccessToken String? // Token criptografado para Azure DevOps
  lastSyncAt  DateTime? // Data da última sincronização bem-sucedida
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  teamId      String?
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  
  pullRequests PullRequest[]
  commits      Commit[]
  syncJobs     SyncJob[]

  @@map("repositories")
}

model PullRequest {
  id              String   @id @default(cuid())
  azureId         Int      @unique
  title           String
  description     String?
  status          String
  sourceBranch    String
  targetBranch    String
  createdAt       DateTime
  updatedAt       DateTime
  closedAt        DateTime?
  mergedAt        DateTime?
  cycleTimeDays   Float?
  leadTimeDays    Float?
  reviewTimeDays  Float?
  filesChanged    Int?
  linesAdded      Int?
  linesDeleted    Int?
  isDraft         Boolean  @default(false)

  // Relacionamentos
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  createdById     String
  createdBy       Developer @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  reviews         Review[]
  comments        Comment[]

  @@map("pull_requests")
}

model Review {
  id          String   @id @default(cuid())
  azureId     Int      @unique
  status      String
  vote        Int
  createdAt   DateTime
  updatedAt   DateTime

  // Relacionamentos
  pullRequestId String
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  
  reviewerId    String
  reviewer      Developer @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Comment {
  id          String   @id @default(cuid())
  azureId     Int      @unique
  content     String
  createdAt   DateTime
  updatedAt   DateTime

  // Relacionamentos
  pullRequestId String
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  
  authorId     String
  author       Developer @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Commit {
  id          String   @id @default(cuid())
  azureId     String   @unique
  message     String
  hash        String
  createdAt   DateTime

  // Relacionamentos
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  authorId     String
  author       Developer @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("commits")
}

model SyncJob {
  id            String    @id @default(cuid())
  repositoryId  String
  status        String    // 'pending' | 'running' | 'completed' | 'failed'
  syncType      String    // 'full' | 'incremental'
  startedAt     DateTime?
  completedAt   DateTime?
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relacionamentos
  repository    Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@map("sync_jobs")
}

// Autenticação e Usuários
model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  login         String   @unique
  password      String?  // Senha opcional para usuários Azure AD
  roleId        String   // Referência obrigatória para UserRole
  isActive      Boolean  @default(true)
  status        String   @default("active") // 'active' | 'pending' | 'inactive'
  azureAdId     String?  @unique // ID do usuário no Azure AD
  azureAdEmail  String?  // Email do Azure AD (pode ser diferente do email principal)
  developerId   String?  // Vínculo com cadastro de desenvolvedor
  viewScope     String   @default("own") // 'own' | 'teams' | 'all' - Controle de visualização de dados
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relacionamentos
  role      UserRole  @relation(fields: [roleId], references: [id], onDelete: Restrict)
  tokens    UserToken[]
  userTeams UserTeam[] // Relacionamento com equipes
  notifications Notification[] @relation("NotificationTarget") // Notificações relacionadas a este usuário
  receivedNotifications Notification[] @relation("NotificationRecipient") // Notificações recebidas por este usuário

  @@map("users")
}

model UserRole {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions String[] // Array de permissões
  isSystem    Boolean  @default(false)
  isDefault   Boolean  @default(false) // Flag para indicar role padrão para novos usuários
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  users       User[]

  @@map("user_roles")
}

model UserToken {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_tokens")
}

model UserTeam {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  role      String   @default("member") // 'member' | 'coordinator' | 'manager'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("user_teams")
}

// Sistema de Notificações
model Notification {
  id            String   @id @default(cuid())
  type          String   @default("user_approval") // "user_approval"
  title         String   // "Novo usuário aguardando aprovação"
  message       String   // "João Silva (joao@empresa.com)"
  status        String   @default("unread") // "unread" | "read" | "action_taken"
  metadata      Json?    // { userId: "xxx", userName: "João", userEmail: "joao@empresa.com" }
  createdAt     DateTime @default(now())
  readAt        DateTime?
  actionTakenAt DateTime?
  actionTakenBy String?  // ID do admin que tomou ação
  
  // Relacionamentos
  targetUserId  String?  // ID do usuário que precisa de aprovação
  targetUser    User?    @relation("NotificationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  recipientId   String?  // ID do admin que deve receber a notificação
  recipient     User?    @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

// API Keys para autenticação entre serviços
model ServiceApiKey {
  id          String    @id @default(cuid())
  serviceName String
  apiKey      String    @unique
  permissions String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?

  @@map("service_api_keys")
}
